let watchedCount=0;function incWatch(){watchedCount++;updateProgress();checkShopUnlock();}function updateProgress(){if(!SHOW_PROGRESS)return;const el=document.getElementById('progress');if(el)el.innerText=`Videos watched: ${watchedCount%SHOP_UNLOCK_AFTER}/${SHOP_UNLOCK_AFTER}`;}function checkShopUnlock(){if(watchedCount>0 && watchedCount%SHOP_UNLOCK_AFTER===0){showShopPopup();}}function showShopPopup(){const pop=document.getElementById('shopPopup');if(!pop)return;pop.classList.add('active');const card=document.getElementById('supporterCard');if(SHOW_SUPPORTERS&&card){card.style.display='block';}}function closeShopPopup(){const pop=document.getElementById('shopPopup');if(pop)pop.classList.remove('active');}window.closeShopPopup=closeShopPopup;async function fetchPlaylist(){if(!YOUTUBE_API_KEY||YOUTUBE_API_KEY.includes('REPLACE')){return [];}try{const url=`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=10&playlistId=${encodeURIComponent(YOUTUBE_PLAYLIST_ID)}&key=${encodeURIComponent(YOUTUBE_API_KEY)}`;const r=await fetch(url);const j=await r.json();return (j.items||[]).map(it=>({type:'video',id:it.snippet.resourceId.videoId,title:it.snippet.title}));}catch(e){return []}}function renderCard(item){const wrap=document.createElement('div');wrap.className='card';if(item.type==='video'){wrap.innerHTML=`<div style="position:relative;padding-bottom:56%;height:0"><iframe src="https://www.youtube.com/embed/${item.id}" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%"></iframe></div><p>${item.title||''}</p><button class='btn' onclick='incWatch()'>Mark Watched</button>`;}else if(item.type==='quote'){wrap.innerHTML=`<blockquote style="font-size:1.1rem; line-height:1.4"><span>“${item.text}”</span><br/><small style="opacity:.8">— ${item.author||'Arron'}</small></blockquote>`;}return wrap;}async function loadFeed(targetId='feed',mixQuotes=true){const target=document.getElementById(targetId);if(!target)return;let items=[];if(SANITY_FEED_MODE.autoOnVisit){items=items.concat(await fetchPlaylist());}if(ENABLE_FALLBACK_QUOTES&&(!items.length||mixQuotes)){const quotes=[{type:'quote',text:'Stars are not perfect — they are burning chaos, yet we call them beautiful.',author:'Arron'},{type:'quote',text:'Sanity is not the absence of madness; it is the art of turning it into meaning.',author:'Arron'},{type:'quote',text:'Every tear carries a galaxy’s reflection.',author:'Arron'}];items=items.concat(quotes);}items.forEach(it=>target.appendChild(renderCard(it)));updateProgress();}async function generateMore(){const target=document.getElementById('feed');const items=await fetchPlaylist();items.forEach(it=>target.appendChild(renderCard(it)));}window.generateMore=generateMore;